#  Branca

[![Latest Version](https://img.shields.io/npm/v/branca.svg?style=flat-square)](https://www.npmjs.com/package/branca)
[![Software License](https://img.shields.io/badge/license-MIT-brightgreen.svg?style=flat-square)](LICENSE.md)
[![Build Status](https://img.shields.io/travis/tuupola/branca-js/master.svg?style=flat-square)](https://travis-ci.org/tuupola/branca-js)
[![Coverage](https://img.shields.io/codecov/c/github/tuupola/branca-js.svg?style=flat-square)](https://codecov.io/github/tuupola/branca-js)

## What?

[Branca](https://github.com/tuupola/branca-spec) is a secure easy to use token format which makes it hard to shoot yourself in the foot. It uses IETF XChaCha20-Poly1305 AEAD symmetric encryption to create encrypted and tamperproof tokens. Payload itself is an arbitrary sequence of bytes. You can use for example a JSON object, plain text string or even binary data serialized by [MessagePack](http://msgpack.org/) or [Protocol Buffers](https://developers.google.com/protocol-buffers/). It is possible to use [Branca as an alternative to JWT](https://appelsiini.net/2017/branca-alternative-to-jwt/).

## Install

Install the library using [Yarn](https://yarnpkg.com/en/) or [npm](https://www.npmjs.com/).

``` bash
$ yarn add branca
$ npm install branca
```

## Usage

### Security

The token `key` must be a 32 byte Hex string (64 hex symbols) representing a cryptographically secure random value. The easiest way to generate it locally is in a `node` repl or using `openssl` (don't use this example hex!):

Node.js

```js
> crypto.randomBytes(32).toString('hex')
'91a61ce530017c3a17cc20396c6ab52cbea016671124c5d57826042ef6075fe5'
```

OpenSSL

```sh
$ openssl rand -hex 32
6d846ea8608fc943f51f22f2018645b0eb41206d916f1df5c0bf091ef3f5f9b7
```

If the Hex string is prefixed with a `0x` it will be ignored.

For backwards compatibility with test vectors a 32 byte plaintext password style string
may also be used, but this is considered insecure. All new keys should **only** use
cryptographically secure randomly generated bytes.

### Payload

Token payload can be any arbitrary data such as string containing an email
address.

```javascript
/* 32 byte hex string secret key */
const key = "deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeef";
const branca = require("branca")(key);

const token = branca.encode("tuupola@appelsiini.net");
console.log(token);

/*
n8EQdroaT1Kr6pJQ6vWDIUlzY6A1pIWMqUk6NJ1WfYzmhWehep70ZQxaDiKFdQuUmH5DoRX9EkfdEvdllfwVsVm48L
*/

const payload = branca.decode(token);
console.log(payload.toString());

/* tuupola@appelsiini.net */

```

You can also use hex encoded secret keys.

```javascript
/* 32 byte secret key */
const key = Buffer.from("7ed049e344f73f399ba1f7868cf9494f4b13347ecce02a8e463feb32507b73a5", "hex");
const branca = require("branca")(key);

const token = branca.encode("tuupola@appelsiini.net");
console.log(token);

/*
n8EQKt90ayFVXUlTFvj4ToPvJFmTT9ACV9IlR4qGGcIi3LThKnbacHn0N08hSG0PTTHRbLQTzc3vlvyqRZ5Te80G8w
*/

const payload = branca.decode(token);
console.log(payload.toString());

/* tuupola@appelsiini.net */

```


Sometimes you might prefer JSON.

```javascript
/* 32 byte hex string secret key */
const key = "deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeef";
const branca = require("branca")(key);
const json = JSON.stringify({"scope": ["read", "write", "delete"]});
const token = branca.encode(json);
console.log(token);

/*
5R9jcYzm4xmeAkjbWE7yCER2Y0PIFvXyS3bqkzMfFgPi9FNiw8MaFStIqPDu22yCXalFnYyuiweOmHQ8Y903fAX9cCYYAPiIcBpOLR6aAc7b
*/

const payload = JSON.parse(branca.decode(token));
console.log(payload);

/* { scope: [ 'read', 'write', 'delete' ] } */
```

You can keep the token size small by using a space efficient serialization method such as [MessagePack](http://msgpack.org/) or [Protocol Buffers](https://developers.google.com/protocol-buffers/).

```javascript
/* 32 byte hex string secret key */
const key = "deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeef";
const branca = require("branca")(key);
const msgpack = require("msgpack5")();

const packed = msgpack.encode({"scope": ["read", "write", "delete"]});
const token = branca.encode(packed);
console.log(token);

/*
3iLBybBOHSPyOpoOYado2s4BE5VswdiPOgSPMfx8FVgam9yYXUEQOvMFGDGAEIh9zoeS9eT1K4fjVicjlGVkJdZzkCX5CroY
*/

const binary = branca.decode(token);
const payload = msgpack.decode(Buffer.from(binary));
console.log(payload);

/* { scope: [ 'read', 'write', 'delete' ] } */
```

## Testing

You can run tests manually with the following command.

``` bash
$ node test.js
```

## Contributing

Please see [CONTRIBUTING](CONTRIBUTING.md) for details.

## Security

If you discover any security related issues, please email tuupola@appelsiini.net instead of using the issue tracker.

## License

The MIT License (MIT). Please see [License File](LICENSE.md) for more information.
